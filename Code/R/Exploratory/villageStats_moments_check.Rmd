---
title: "Intermediate outputs for sanity checks (Only No Endorsement Model)"
author: "Sakina Shibuya"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
##### From Hiro's code

rm(list = ls())

# Load packages

packages <- c(
  "R.matlab",
  "tidyverse",
  "igraph",
  "pracma",
  "ggplot2",
  "plotly",
  "dqrng",
  "Matrix", 
  "summarytools", 
  "data.table")

not_installed <- !packages %in% installed.packages()
if (any(not_installed)) install.packages(packages[not_installed])
lapply(packages,require,character.only = TRUE)

# Global setting
user <- "Sakina"
if (user == "Hiro"){
  project_path <- "/Users/mizuhirosuzuki/Dropbox/MFdiffusion_replication/"
}
if (user == "Sakina"){
  project_path <- "/home/sakina/Github/MFdiffusion_replication"
}
```

## Betas (coefficients from logistic model)

This is a sanity check.

: Coefficients of the logistic regressions 

|               | **From Matlab** | **R**  |
|:-------------:|:---------------:|:------:|
| **B1**        | 0.007           | 0.007  |
| **B2**        | -0.283          | -0.283 |
| **B3**        | 0.156           | 0.156  |
| **B4**        | 0.179           | 0.179  |
| **B5**        | -1.023          | -1.023 |
| **B6**        | 1.147           | 1.147  |
| **Intercept** | -1.210          | -1.210 |


## Check village statistics

### Model 1 (qN = qP)
```{r}
load(file = file.path(project_path, 'Rdata/data_model_1_netstats_1_trimesters.RData'))

# Make a proper 
ls.df.M1 <- list()
ls.agg.df.M1 <- list()
for (i in seq(length(netstats))) {
  
  # Convert to data frames so it's easier to manipulate
  ls.df.M1[[i]] <- data.frame(matrix(unlist(netstats[[i]]), nrow=length(netstats[[i]][[1]]))) 
  
  # Calculate village means of all variables
  ls.df.M1[[i]]$one <- 1
  ls.agg.df.M1[[i]] <- aggregate(. ~ one, ls.df.M1[[i]], FUN = mean)
  ls.agg.df.M1[[i]]$one <- NULL
}

village.df.M1 <- data.frame(matrix(unlist(ls.agg.df.M1), nrow = length(ls.agg.df.M1)))
village.df.M1$villageID <- rownames(village.df.M1)
village.df.M1 <- village.df.M1 %>% rename(minDistFromLeaders = X1, avgDistFromLeaders = X2, 
                                    minDistInfectedLeaders = X3, minDistNonInfectedLeaders = X4, 
                                    neighborOfInfected = X5, neighborOfNonInfected = X6,
                                    network_degree = X7)

# Descriptive stats table
descr(village.df.M1[, 1:7], stats = "common", transpose = T, headings = F, style = "rmarkdown")
```

### Model 3 (qN $\ne$ qP)

## Check moments

Those moments are:

* V1 $\rightarrow$ Fraction of nodes that have no taking neighbors but are takers themselves 

* V2 $\rightarrow$ Fraction of individuals that are infected in the neighborhood of infected leaders stats_1 
* V3 $\rightarrow$ Fraction of individuals that are infected in the neighborhood of non-infected leaders 

* V4 $\rightarrow$ Covariance of individuals taking with share of neighbors taking 

* V5 $\rightarrow$ Covariance of individuals taking with share of second neighbors taking

The D matrix stores the difference between simulated and empirical values of each of the above moments. 

### Model 1  (qN = qP) 
&nbsp;
The results are pretty close. I think the previous differences that we saw may be from rounding up.
Some values seem a bit odd. For instance, the difference between the empirical and simulated V2 values doesn't seem like it should be 0.
This is purely due to rounding up.

What's a bit wierd is that there are some visible differences in empirical values between R and Matlab in V2 and V3. 
Not too sure what to think about this.

: Model 1 Results Comparison between R and Matlab (Mean)

| **From Matlab** | Empirical | Simulation Mean | Difference |
|:---------------:|:---------:|:---------------:|:----------:|
| **V1**          | 0.11      | 0.16            | 0.05       |
| **V2**          | 0.31      | 0.18            | -0.12      |
| **V3**          | 0.16      | 0.16            | 0.01       |
| **V4**          | 0.06      | 0.04            | -0.02      |
| **V5**          | 1.61      | 1.48            | -0.14      |
|                 |           |                 |            |
| **From R**      |           |                 |            |
|                 |           |                 |            |
| **V1**          | 0.11      | 0.16            | 0.05       |
| **V2**          | 0.20      | 0.19            | 0.00       |
| **V3**          | 0.21      | 0.17            | -0.04      |
| **V4**          | 0.06      | 0.04            | -0.02      |
| **V5**          | 1.61      | 1.48            | -0.14      |


### Model 3  (qN $\ne$ qP) 

&nbsp;

There are a bit more differences in the model 3 estimates. The difference between simulated means in V5 is pretty big. 

: Model 3 Results Comparison between R and Matlab (Mean)

| **From Matlab** | Empirical | Simulation Mean | Difference |
|:---------------:|:---------:|:---------------:|:----------:|
| **V1**          | 0.11      | 0.16            | 0.05       |
| **V2**          | 0.31      | 0.21            | -0.09      |
| **V3**          | 0.16      | 0.19            | 0.04       |
| **V4**          | 0.06      | 0.05            | -0.01      |
| **V5**          | 1.61      | 1.68            | 0.06       |
|                 |           |                 |            |
| **From R**      |           |                 |            |
|                 |           |                 |            |
| **V1**          | 0.11      | 0.23            | 0.12       |
| **V2**          | 0.20      | 0.24            | 0.05       |
| **V3**          | 0.21      | 0.24            | 0.03       |
| **V4**          | 0.06      | 0.06            | 0.00       |
| **V5**          | 1.61      | 2.08            | 0.47       |





<!-- The following commands show where the numbers in the above table come from. 

# Betas
![Betas from R](betas_logCoeffs_R.png) 

![Betas from Matlab](betas_logCoeffs_M.png)

# Model 1

```{r include=FALSE}
load(file = file.path(project_path, 'Rdata/data_model_1_div_output_1_trimesters.RData'))

# div_out[[nth simulation]][[1]] = D; div_out[[nth simulation]][[2]] = EmpiricalMoments; div_out[[nth simulation]][[3]] = MeanSimulatedMoments

villmnD.M1 <- list()
villmnE.M1 <- list()
villmnS.M1 <- list()
for (i in seq(length(div_output))) { # Sequence of the number of simulations
  villmnD.M1[[i]] <- apply(div_output[[i]][[1]], 2, mean) # Difference between the empirical and mean simulated moments
  villmnE.M1[[i]] <- apply(div_output[[i]][[2]], 2, mean) # Empirical moments
  villmnS.M1[[i]] <- apply(div_output[[i]][[3]], 2, mean) # Mean simulated moments
}

Ls2Df <- function(ls) {
  df <- as.data.frame(rbindlist(lapply(ls, as.data.frame.list), 
                                use.names=FALSE)
                      )
  df <- df %>% rename(V1 = names(df)[1], V2 = names(df)[2], 
                      V3 = names(df)[3], V4 = names(df)[4], 
                      V5 = names(df)[5]
                      )
  return(df)
}

lsMom.M1 <- list(villmnD.M1, villmnE.M1, villmnS.M1)
Dfs.M1 <- lapply(lsMom.M1, Ls2Df)
```

```{r include=FALSE}
# Empirical moments
descr(Dfs.M1[[2]], stats = "common", transpose = T, headings = F, style = "rmarkdown")
```

```{r include=FALSE}
# Mean simulated moments
descr(Dfs.M1[[3]], stats = "common", transpose = T, headings = F, style = "rmarkdown")
```

```{r include=FALSE}
# Difference between empirical and mean simulated moments
descr(Dfs.M1[[1]], stats = "common", transpose = T, headings = F, style = "rmarkdown")
```


![From Matlab](moments_fromMatlab_model1.png)

# Model 3

```{r include=FALSE}
# Div_out for Model 3 is a list of 31X39 simulation results, each of which is a list of 3 43x5 vectors.
load(file = file.path(project_path, 'Rdata/data_model_3_div_output_1_trimesters.RData'))

# Calculate the average for each moment for each simulation
villmnD.M3 <- list()
villmnE.M3 <- list()
villmnS.M3 <- list()
for (i in seq(length(div_output))) { # Sequence of the number of simulations
  if (length(div_output[[i]]) != 0) {
    villmnD.M3[[i]] <- apply(div_output[[i]][[1]], 2, mean) # D
    villmnE.M3[[i]] <- apply(div_output[[i]][[2]], 2, mean) # Empirical moments]
    villmnS.M3[[i]] <- apply(div_output[[i]][[3]], 2, mean) # Mean simulated moments
  }
} # We need lappy, rather than apply, because some simlation produced 0 length.

lsMom.M3 <- list(villmnD.M3, villmnE.M3, villmnS.M3)
Dfs.M3 <- lapply(lsMom.M3, Ls2Df)

# 744 out of 1209 simulations are empty.
# test <- c()
# for (i in seq(1209)) {
#     test[i] <- as.numeric(ifelse(length(div_output[[i]]) == 0, 1, 0)) 
#     }
```


```{r}
# Empirical moments (This is more of a sanity check since this is the same as before.)
descr(Dfs.M3[[2]], stats = "common", transpose = T, headings = F, style = "rmarkdown")
```


```{r}
# Mean simulated moments
descr(Dfs.M3[[3]], stats = "common", transpose = T, headings = F, style = "rmarkdown")

```

```{r}
# Difference between empirical and mean simulated moments
descr(Dfs.M3[[1]], stats = "common", transpose = T, headings = F, style = "rmarkdown")
```


Result pic: ![From Matlab](moments_fromMatlab_model3.png) 
-->



